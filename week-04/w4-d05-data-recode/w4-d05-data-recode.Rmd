---
title: "Recoding data"
subtitle: "<br><br> Introduction to Data Science"
author: "[introds.org](https://introds.org/)"
date: "<br> Dr. Mine Ã‡etinkaya-Rundel"
output:
  xaringan::moon_reader:
    css: ["../../xaringan-themer.css", "../../slides.css"]
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r child = "../../setup.Rmd"}
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
```

class: middle

# Case study: Religion and income

---

```{r echo=FALSE, out.width="75%"}
knitr::include_graphics("img/relig-income.png")
```

.footnote[
Source: [pewforum.org/religious-landscape-study/income-distribution](https://www.pewforum.org/religious-landscape-study/income-distribution/), Retrieved 14 April, 2020
]

---

## Read data 

```{r}
library(readxl)
rel_inc <- read_excel("data/relig-income.xlsx")
```

.small[
```{r echo=FALSE}
rel_inc
```
]

---

## Rename columns

.midi[
```{r}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  )
```
]

---

.question[
If we want a new variable called `income` with levels such as "Less than $30,000", "$30,000-$49,999", ... etc. which function should we use?
]

```{r echo=FALSE}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n),   # all but religion and n
    names_to = "income", 
    values_to = "proportion"
  ) %>%
  print(n = 15)
```

---

## Pivot longer

.midi[
```{r}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n),   # all but religion and n
    names_to = "income", 
    values_to = "proportion"
  )
```
]

---

## Calculate frequencies

.midi[
```{r}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n), 
    names_to = "income", 
    values_to = "proportion"
  ) %>%
  mutate(frequency = round(proportion * n))
```
]

---

## Save data

```{r}
rel_inc_long <- rel_inc %>% #<<
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n), 
    names_to = "income", 
    values_to = "proportion"
  ) %>%
  mutate(frequency = round(proportion * n))
```

---

## Religion

```{r out.width="65%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency)) +
  geom_col()
```

---

## Recode religion

```{r out.width="55%"}
rel_inc_long <- rel_inc_long %>%
  mutate(religion = case_when(
    religion == "Evangelical Protestant"           ~ "Ev. Protestant",
    religion == "Historically Black Protestant"    ~ "Hist. Black Protestant",
    religion == 'Unaffiliated (religious "nones")' ~ "Unaffiliated",
    TRUE                                           ~ religion
  ))

ggplot(rel_inc_long, aes(y = religion, x = frequency)) + 
  geom_col()
```


---

## Reverse religion order

```{r out.width="55%"}
rel_inc_long <- rel_inc_long %>%
  mutate(religion = fct_rev(religion)) #<<

ggplot(rel_inc_long, aes(y = religion, x = frequency)) + 
  geom_col()
```

---

## Add income

```{r out.width="65%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) + #<<
  geom_col() 
```

---

## Fix income level ordering

```{r}
rel_inc_long <- rel_inc_long %>%
  mutate(
    income = fct_relevel(income, "$100,000 or more", #<<
                         "$50,000-$99,999", "$30,000-$49,999", #<<
                         "Less than $30,000") #<<
    )
```

---

## Plot again

```{r out.width="65%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) + 
  geom_col()
```

---

## Fill bars

.small[
```{r out.width="65%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") #<<
```
]

---

## Change colors

.small[
```{r out.width="65%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() #<<
```
]

---


## Change theme

.small[
```{r out.width="60%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() #<<
```
]

---

## Move legend to the bottom

.midi[
```{r bottom-legend, fig.show="hide"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(legend.position = "bottom") #<<
```
]

---

## Move legend to the bottom (plot)

```{r ref.label = "bottom-legend", echo=FALSE, out.width="80%"}
```

---

## Legend adjustments

.panelset[

.panel[.panel-name[Code]
```{r legend-adjust, fig.show="hide"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) #<<
```
]

.panel[.panel-name[Plot]
```{r ref.label = "legend-adjust", echo=FALSE, out.width="65%"}
```
]

]

---

## Fix labels

.panelset[

.panel[.panel-name[Code]
```{r fix-labels, fig.show="hide"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  labs(
    x = "Proportion", y = "", #<<
    title = "Income distribution by religious group", #<<
    subtitle = "Source: Pew Research Center, Religious Landscape Study", #<<
    fill = "Income" #<<
    )
```
]

.panel[.panel-name[Plot]
```{r ref.label = "fix-labels", echo=FALSE, out.width="65%"}
```
]

]
